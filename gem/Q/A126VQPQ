§@ªÌ: itoc (¯¸¤W¤H¼Æ¡G802) ¯¸¤º: plan
¼ÐÃD: [¥\¯à] ¥xÅK®É¨è¬d¸ß
®É¶¡: 2006/05/21 Sun 12:17:12                           Updated: 2006/05/21

: menu.c ¾A·íªº¿ï³æ¥[¤W³o¤G¦æ

+ "bin/railway.so:main_railway", 0, - M_XMODE,
+ "Railway    ¡ñ ¤õ¨®®É¨è ¡ð",

: game/Makefile

SO =    ... [1;33mrailway.so[m

: game/railway.c ·s¼W¦¹µ{¦¡

/*-------------------------------------------------------*/
/* railway.c    ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : ¥xÅK¤õ¨®®É¨èªí¬d¸ß                           */
/* create : 02/05/29                                     */
/* update :   /  /                                       */
/* author : lp@micro.ee.nthu.edu.tw                      */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#if 0
  1. »Ý­n¦w¸Ë lynx¡Bpiconv¡Bgrep¡A¥B½ÐÀË¬d³o¤TªÌ¦b http_conn()
     ¸Ì­±ªº¸ô®|¬O§_¥¿½T¡C
  2. µ{¦¡ÁöµM¦³Âà¨®¯¸ªº³¡¤À¡A¦ý¬O¥Ø«e¨S¦³¥Î¡C
#endif

#include "bbs.h"

#define mouts(x,y,s)    { move(x, y); outs(s); }

#define FORM_railway    "\"SBeginStation=%s&SBeginStationName=&SEndStation=%s&SEndStationName=&SClass=%s&SDateTime=%s&STime=&SearchType=0&SBeginCityCode=&SEndCityCode=&BStationIndex=&EStationIndex=\""

#define REF             "http://www.railway.gov.tw/"

#define RAILWAY_XPOS    1
#define RAILWAY_YPOS    0
#define MAX_SITE        212
#define SITE_PER_LINE   13      /* ¨C¦C¨q 13 ­Ó¯¸¥x */

static char *siteid[MAX_SITE] = /* ¨®¯¸¯¸¥x */
{
  "¥xªF", "¤s¨½", "³À³¥", "·ç·½", "·ç©M", "¤ë¬ü", "Ãö¤s", "®üºÝ", "¦À¤W", "´I¨½", "ªF¦Ë", "ªF¨½", "¦w³q",
  "¥É¨½", "¤T¥Á", "·çÁJ", "´I·½", "¤j´I", "¥ú´_", "¸Uºa", "»ñªL", "«n¥­", "·Ë¤f", "Â×¥Ð", "¹ØÂ×", "¥­©M",
  "§Ó¾Ç", "¦N¦w", "ªá½¬", "¥_®H", "´º¬ü", "·s«°", "±R¼w", "©M¤¯", "©M¥­", "º~¥»", "ªZ¶ð", "«n¿D", "ªF¿D",
  "¥Ã¼Ö", "Ä¬¿D","Ä¬¿D·s","·s°¨", "¥V¤s", "Ã¹ªF", "¤¤¨½", "¤Gµ²", "©yÄõ", "¥|«°", "ÁG·Ë", "³»®H", "ÀY«°",
  "¥~¿D", "Àt¤s", "¤j·Ë", "¤j¨½", "¥Û«°", "ºÖ¶©", "°^¼d", "Âù·Ë", "¨d¤¦","¤T¶IÀ­","«JÖ»","·çªÚ","¥|¸}«F",
  "·x·x", "°ò¶©", "¤T§|", "¤K°ô", "¤C°ô", "¤­°ô", "¦Á¤î", "«n´ä", "ªQ¤s", "¥x¥_", "¸UµØ", "ªO¾ô", "¾ðªL",
  "¤s¨Î", "Åaºq", "®ç¶é", "¤ºÃc", "¤¤Ãc", "®H¤ß", "·¨±ö", "´I©£", "´ò¤f", "·sÂ×", "¦Ë¥_", "·s¦Ë", "­»¤s",
  "±T³»", "¦Ë«n", "½Í¤å", "¤j¤s", "«áÀs", "Às´ä","¥Õ¨F¤Ù","·s®H", "³q¾]", "­b¸Ì", "¤é«n","¤j¥Ò","¥x¤¤´ä",
  "²M¤ô", "¨F³À", "Às¤«", "¤j¨{", "°l¤À", "³y¾ô", "Â×´I", "­]®ß", "«n¶Õ", "»ÉÆr", "¤T¸q", "®õ¦w", "¦Z¨½",
  "Â×­ì", "¼æ¤l", "¤Ó­ì", "¥x¤¤", "¤j¼y", "¯Q¤é", "¦¨¥\\","¹ü¤Æ", "ªá¾Â", "¤j§ø", "­ûªL", "¥Ã¹t", "ªÀÀY",
  "¥Ð¤¤", "¤G¤ô", "ªL¤º", "¥Ûºh", "¤æ¤»", "¤æ«n", "¥ÛÀt", "¤jªL", "¥Á¶¯", "¹Å¸q", "¤ô¤W", "«n¹t", "¹Å¥_",
  "«á¾À", "·sÀç", "¬hÀç","ªL»ñÀç","¶©¥Ð", "©ÞªL", "µ½¤Æ", "·s¥«", "¥Ã±d", "¤j¾ô", "¥x«n", "«O¦w", "¤¤¬w",
  "¤j´ò", "¸ô¦Ë", "©£¤s", "¾ôÀY", "·£±ê", "¥ªÀç", "°ª¶¯", "»ñ¤s", "«áÉÜ","¤E¦±°ó","¤»¶ô­í","«ÌªF","Âk¨Ó",
  "Åï¬¥", "¦è¶Õ", "¦Ë¥Ð", "¼é¦{", "®r³»", "«n¦{", "Âí¦w", "ªLÃä", "¨Î¥V", "ªF®ü", "ªD¼d", "¥[¸S", "¤º·à",
  "ªD¤s", "¥j²ø", "¤jªZ", "ò]·Ë", "¦h¨}", "ª÷±[","¤Ó³Â¨½","ª¾¥»", "±d¼Ö", "¤jµØ", "¤Q¤À", "±æ¥j", "À­¸}",
  "¥­·Ë", "µ×®ä", "¦Ë¤¤", "¤W­û", "ºaµØ", "¦ËªF", "¾î¤s","¤EÆgÀY","¦X¿³", "´I¶Q", "¤ºÆW", "·½¬u", "¿B¤ô",
  "Às¬u", "¶°¶°", "¤ô¨½", "¨®ÑL"
};


static char *siteno[MAX_SITE] = /* ¨®¯¸¥N½X */
{
  "1632", "1631", "1630", "1629", "1628", "1627", "1626", "1625", "1624", "1623", "1622", "1621", "1620",
  "1619", "1617", "1616", "1614", "1613", "1612", "1611", "1610", "1609", "1608", "1607", "1606", "1605",
  "1604", "1602", "1715", "1714", "1713", "1712", "1711", "1710", "1709", "1708", "1706", "1705", "1704",
  "1703", "1827", "1826", "1825", "1824", "1823", "1822", "1821", "1820", "1819", "1818", "1817", "1816",
  "1815", "1814", "1813", "1812", "1811", "1810", "1809", "1808", "1807", "1806", "1805", "1804", "1803",
  "1802", "1001", "1029", "1002", "1003", "1004", "1005", "1006", "1007", "1008", "1009", "1011", "1012",
  "1013", "1014", "1015", "1016", "1017", "1018", "1019", "1020", "1021", "1022", "1023", "1025", "1026",
  "1027", "1028", "1102", "1104", "1105", "1106", "1107", "1108", "1109", "1110", "1111", "1112", "1113",
  "1114", "1115", "1116", "1117", "1118", "1302", "1304", "1305", "1307", "1308", "1310", "1314", "1315",
  "1317", "1318", "1323", "1319", "1322", "1320", "1321", "1120", "1202", "1240", "1203", "1204", "1205",
  "1206", "1207", "1208", "1209", "1210", "1211", "1212", "1213", "1214", "1215", "1217", "1218", "1241",
  "1219", "1220", "1221", "1222", "1223", "1224", "1225", "1226", "1227", "1239", "1228", "1229", "1230",
  "1231", "1232", "1233", "1234", "1235", "1236", "1238", "1402", "1403", "1404", "1405", "1406", "1407",
  "1408", "1409", "1410", "1411", "1412", "1413", "1414", "1415", "1416", "1417", "1418", "1502", "1503",
  "1504", "1507", "1508", "1510", "1511", "1512", "1514", "1516", "1517", "1903", "1904", "1905", "1906",
  "1907", "1908", "2203", "2204", "2211", "2205", "2206", "2207", "2208", "2209", "2210", "2702", "2703",
  "2704", "2705", "2706", "2707"
};


static int cx, cy;
static int fr_pos, to_pos, tr_pos;
static char fr_no[5], to_no[5], tr_no[4];       /* °_¨´ ¥N½X */
static char typer[5];                           /* ¹ï¸¹/«D¹ï¸¹ */


static void
outs_site(pos)
  int pos;
{
  char *site;

  site = siteid[pos];
  if (site[4] == '\0')
    prints(" %s ", site);
  else
    outs(site);
}


static void
outs_info(color, msg)
  int color;
  char *msg;             /* strlen(msg) == 14 */
{
  move(b_lines, 0);
  clrtoeol();
  move(b_lines, 30);     /* ¸m¤¤ */
  prints("\033[%dm %s \033[m", color, msg);
}


static void
site_drawrow(x)          /* ­«Ã¸ x ¦C */
  int x;
{
  int i;

  move(x + RAILWAY_XPOS, RAILWAY_YPOS);
  i = x * SITE_PER_LINE;
  x = (x + 1) * SITE_PER_LINE;
  if (x > MAX_SITE)
    x = MAX_SITE;
  for (; i < x; i++)
  {
    if (i == fr_pos)
      outs("\033[41m");
    else if (i == to_pos)
      outs("\033[44m");
    else if (i == tr_pos)
      outs("\033[42m");
    outs_site(i);
    if (i == fr_pos || i == to_pos || i == tr_pos)
      outs("\033[m");
  }
}


static void
site_show()
{
  int i;

  clear();
  move(0, 23);
  outs("\033[1;37;44m¡· ¥xÅK¤õ¨®®É¨èªí¬d¸ß¨t²Î ¡·\033[5;33m ´ú¸Õª©\033[m");

  for (i = 0; i < MAX_SITE; i++)
  {
    if (i % SITE_PER_LINE == 0)
      move(i / SITE_PER_LINE + RAILWAY_XPOS, RAILWAY_YPOS);
    outs_site(i);
  }

  move(b_lines - 4, 0);
  outs("±Òµ{¨®¯¸¡G         ¨ì¹F¨®¯¸¡G");
  move(b_lines - 3, 0);
  outs("¬d¸ß®É¶¡¡G00:00 ¦Ü 24:00 (¤º©w, µLªk§ï)");
  move(b_lines - 2, 0);
  outs("¬d¸ß¨®ºØ¡G1)¹ï¸¹§Ö¨® 2)«D¹ï¸¹¨® 3)¥þ³¡¨®ºØ");

  cx = cy = 0;
  fr_pos = to_pos = tr_pos = -1;

}


static int              /* 1:¦¨¥\ */
site_choose(flag)
  int flag;             /* 1:¿ï°_¯¸  2:¿ï¨´¯¸  4: ¿ïÂà¯¸ */
{
  int pos;

  /* ³o´X®æ¨S¦³¯¸¥x */
  if (cx == MAX_SITE / SITE_PER_LINE && cy >= MAX_SITE % SITE_PER_LINE)
    return 0;

  pos = cx * SITE_PER_LINE + cy;

  if (flag == 1)
  {
    fr_pos = pos;
    strcpy(fr_no, siteno[fr_pos]);
    move(b_lines - 4, 10);
    prints("%-6s", siteid[fr_pos]);
  }
  else if (flag == 4)
  {
    if (fr_pos == pos)
      return 0;
    to_pos = pos;
    strcpy(to_no, siteno[to_pos]);
    move(b_lines - 4, 29);
    outs(siteid[to_pos]);
  }
  else /* if (flag == 2) */
  {
    if (fr_pos == pos || to_pos == pos)
      return 0;
    tr_pos = pos;
    strcpy(tr_no, siteno[tr_pos]);
    move(b_lines - 4, 48);
    outs(siteid[tr_pos]);
  }

  site_drawrow(cx);
  return 1;       /* ¿ï¤U¤@­Ó */
}


static int              /* 1: ¤w¨M©w°_¨´¯¸ */
site_menu(flag)         /* ¥Ø«e¦b¿ï 1:°_ 4:¨´ 2:Âà ¯¸ */
  int flag;
{
  for (;;)
  {
    /* itoc.031209: ­Y¹J¨ì¤T­Ó¦rªº¯¸¦W¡A¤S°»´ú¥þ§Î®É¡A¨º»ò·|¦h¸õ¤@¦¸¡A¼È®É¤£ºÞ¤F :p */
    move(cx + RAILWAY_XPOS, cy * 6 + RAILWAY_YPOS + 2);
    switch (vkey())
    {
    case KEY_RIGHT:
      cy++;
      if (cy > 12)
        cy = 0;
      break;

    case KEY_LEFT:
      cy--;
      if (cy < 0)
        cy = 12;
      break;

    case KEY_DOWN:
      cx++;
      if (cx > 16)
        cx = 0;
      break;

    case KEY_UP:
      cx--;
      if (cx < 0)
        cx = 16;
      break;

    case KEY_ENTER:
    case ' ':
      if (site_choose(flag))
        return 1;
      break;

    case 'q':
      return 0;
    }
  }
}


static void
rail_query()
{
  char ans[3], *msg;

  outs_info(45, "½Ð¿ï¾Ü¬d¸ß¨®ºØ");

  switch (vget(b_lines - 2, 0, "¬d¸ß¨®ºØ¡G1)¹ï¸¹§Ö¨® 2)«D¹ï¸¹¨® 3)¥þ³¡¨®ºØ¡G[3] ", ans, 3, DOECHO))
  {
  case '1':
    strcpy(typer, "0");
    msg = "1)¹ï¸¹§Ö¨®";
    break;

  case '2':
    strcpy(typer, "1");
    msg = "2)«D¹ï¸¹¨®";
    break;

  default:
    strcpy(typer, "2");
    msg = "3)¥þ³¡¨®ºØ";
    break;
  }

  move(b_lines - 2, 10);
  outs(msg);
  clrtoeol();

  refresh();        /* ¦A¦¸ vget() ·|¥X²{«e­±ªº±±¨î½X¡A­n refresh */
}


static char
Tcolor(str)        /* ¨Ì¨®¦¸¨Ó¨M©wÃC¦â */
  char *str;
{
  if (!strncmp(str, "¦Û±j", 4))
    return '1';
  if (!strncmp(str, "²÷¥ú", 4))
    return '6';
  if (!strncmp(str, "´_¿³", 4))
    return '4';
  return '0';
}


static void
html_parser(src, dst)
  char *src, *dst;
{
  FILE *fpr, *fpw;
  char data[256];
  char *result;
  int line_num;
  int tcount;         /* Á`¦@¦³´X¯Z¦¸ */
  struct stat st;

  if ((!stat(src, &st) && !st.st_size) || !(fpr = fopen(src, "r")))
    return;

  fpw = fopen(dst, "w");

  line_num = 0;
  while (fgets(data, sizeof(data), fpr))
  {
    if (++line_num >= 6)
    {
      fprintf(fpw, "%s", data);
      break;
    }
  }

  line_num++;
  fprintf(fpw, "\n"
    "¢z¢w¢w¢w¢s¢w¢w¢s¢w¢s¢w¢w¢w¢w¢w¢w¢w¢s¢w¢w¢w¢w¢w¢s¢w¢w¢w¢w¢w¢s¢w¢w¢s¢w¢w¢w¢w¢w¢{\n"
    "¢x ­¼§¤ ¢x¨®¦¸¢x¤s¢x©lµo¯¸->²×ÂI¯¸¢xµn¨®¨®¯¸  ¢x¤U¨®¨®¯¸  ¢x¥þ²¼¢x¦æ¾p®É¶¡  ¢x\n"
    "¢x ¨®ºØ ¢x½s¸¹¢x®ü¢x              ¢x¶}¨®®É¶¡  ¢x¨ì¹F®É¶¡  ¢x»ù¿ú¢x          ¢x");

  while (fgets(data, sizeof(data), fpr))
  {
    if (++line_num >= 30)
      break;
  }

  tcount = 0;
  while (1)
  {
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, " ")))
      break;

    fprintf(fpw, "\n¢u¢w¢w¢w¢q¢w¢w¢q¢w¢q¢w¢w¢w¢w¢w¢w¢w¢q¢w¢w¢w¢w¢w¢q¢w¢w¢w¢w¢w¢q¢w¢w¢q¢w¢w¢w¢w¢w¢t");

    /* ¨®«¬¡A6 bytes */
    fprintf(fpw, "\n¢x\033[1;4%c;37m%6.6s\033[m", Tcolor(result), result);        /* §N®ð®ã«È·|¶W¹L 6 bytes */

    /* ¨®¦¸¥N½X¡A4 bytes */
    if (!(result = strtok(NULL, " ")))
      break;
    fprintf(fpw, "¢x%4.4s", result);        /* §N®ð®ã«È·|¶W¹L 4 bytes */

    /* ¤s½u©Î®ü½u©ÎªÅªº¡A2 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "¢x%2s", result + 37);

    /* ±Òµ{¯¸¡B¨ì¹F¯¸¡A6 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "¢x%14s", result + 31);

    /* ¶}¨®®É¶¡ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "¢x%8s  ", result + 32);

    /* ¨ì¹F®É¶¡ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "¢x%8s  ", result + 32);

    /* ¥þ²¼»ù®æ 3 bytes */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")))
      break;
    fprintf(fpw, "¢x%4s", result + 34);

    /* ¦æ¾p®É¶¡ */
    if (!fgets(data, sizeof(data), fpr) || !(result = strtok(data, "\n")) || !(result = strtok( result, " ")))
      break;
    fprintf(fpw, "¢x%10s¢x", result);

    /* ¸õ¹L³Æµù */
    if (!fgets(data, sizeof(data), fpr))
      break;

    tcount++;
  }                 /* end of while */


  fprintf(fpw,  "\n¢|¢w¢w¢w¢r¢w¢w¢r¢w¢r¢w¢w¢w¢w¢w¢w¢w¢r¢w¢w¢w¢w¢w¢r¢w¢w¢w¢w¢w¢r¢w¢w¢r¢w¢w¢w¢w¢w¢}\n\n\n\n");

  if (!tcount)
    fprintf(fpw, "\n\n©êºp¡I¨S¦³±z±ý·f­¼ªº¯Z¨®");

  fclose(fpr);
  fclose(fpw);
}


static int
http_conn(s)
  char *s;
{
  char src[30], dst[30];
  char cmd[768];

  mouts(b_lines - 1, 0, "³s±µ¦øªA¾¹¤¤¡A½Ðµy­Ô...");
    refresh();

  sprintf(src, "tmp/%s.rail", cuser.userid);
  sprintf(cmd, "/usr/local/bin/lynx -display_charset=utf-8 -nolist -dump  "
    "http://new.twtraffic.com.tw/twrail/nonscript_search_result.aspx?%s | "
    "/usr/local/bin/piconv -f utf8 -t big5 | /usr/bin/grep -v '¹Ï¥Ü' > %s",
    s, src);
  system(cmd);

  sprintf(dst, "tmp/%s.way", cuser.userid);
  html_parser(src, dst);

  /* show message that return from the web server */


  if (more(dst, (char *) -1) >= 0)
  {
    if (vans("±z­n±N¬d¸ßµ²ªG±H¦^«H½c¶Ü¡H[N] ") == 'y')
      mail_self(dst, cuser.userid, "[³Æ §Ñ ¿ý] ¤õ¨®®É¨è¬d¸ßµ²ªG", MAIL_READ);
  }
  unlink(dst);
  unlink(src);

  return 0;
}



static void
railway(delay)
  int delay;
{
  char atrn[512];
  char day[20];
  struct tm *ptime;
  time_t now;

  time(&now);
  now += 86400 * delay;
  ptime = localtime(&now);
  sprintf(day, "%02d/%d/%d",
    (ptime->tm_year - 11 ) % 100 , ptime->tm_mon + 1, ptime->tm_mday);

  sprintf(atrn, FORM_railway, fr_no, to_no, typer, day);
  http_conn(atrn);
}


int
main_railway()
{
  int ch;

  site_show();

  outs_info(41, "½Ð¿ï¾Ü±Òµ{¨®¯¸");
  if (!site_menu(1))
    return 0;

  outs_info(44, "½Ð¿ï¾Ü¨ì¹F¨®¯¸");
  if (!site_menu(4))
    return 0;

  rail_query();  /* ¨M©w¹ï¸¹/«D¹ï¸¹ */

  ch = vans("¬d¸ß 0)¤µ¤Ñ 1)©ú¤Ñ 2)«á¤Ñ 3456789)¤Ñ«áªº®É¨èªí Q)Â÷¶}¡H[0] ");
  if (ch == 'q')
  {
    vmsg("hmm.....¤£·Q¬dÅo...^o^");
    return 0;
  }
  if (ch < '0' || ch > '9')
    ch = 0;
  else
    ch -= '0';

  railway(ch);

  return 0;
}

--
[1;37m¡¼ ¥»¤å³¹¥Ñ [33mitoc[37m ±q [32mitoc.Dorm11.NCTU.edu.tw[37m µoªí[m
