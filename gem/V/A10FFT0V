µo«H¤H: Efen.bbs@bbs.med.ncku.edu.tw (§Ú~¬O~­D~¤l) ¬ÝªO: plan
¼Ð  ÃD: ªÑ¥«µ{¦¡½X
µo«H¯¸: °j ­· ¨¦ (2004/07/16 Fri 22:21:40)                Updated: 2004/08/16

»¡©ú¡G

1.¤£¥ð¥«
    ¥»ªÑ¥«¬°24¤p®É¤£¦¬¥«¡A¨S¦³´Á­­¡A´Á±æ­Èªñ©ó¹s¡A¤]´N¬O¨Ã«D©ñµÛ´N·|
    «OÃÒ¥²©wÁÈ¿ú¡A¦Ó¬O»Ý­n°ÊºAªº¾Þ§@¡C

2.º¦¶^­pºâ
    ¨Ì·Ó¦¨¥æ¶qªº¦h¹è¡A¦Ó¦³¤£¦Pªºº¦¶^¾÷²v¡A·íµM¡A·U°ª´N·U¦³¾÷·|¤Wº¦¡A
    ·U§C´N·U¦³¾÷·|¤U¶^¡C
    ¤@¦¸ªºº¦¶^´T«×¥Ø«eºû«ù¦b-2%~+5%ÂI¤§¶¡¡A·|¨ü¦UªÑ¥»¨­ªº¦¨¥æ¶qªº¼vÅT¡C

3.°tÃB¶q
    ¨C¦¸»ù®æÅÜ°Ê«á¡A¦UªÑ¦³¤£¦Pªº°tÃB¼W¥[(0~5)

4.¶}½L»ù
    ¨ú·í¤Ñ¹sÂI¹L«á¡A²Ä¤@¦¸ÅÜ°Ê«áªº»ù®æ¬°¶}½L»ù(¥Ø«e¬°0:05)

5.ªÑ»ùÅÜ°Ê
    ¥Ø«e¬°¨C¤p®ÉÅÜ´«¤T¦¸¡A¤À§O¬°5¡B25¡B45¤À¡A¦U¤@¦¸

6.¦¨¥æ¶q
    ¨Ì·Ó¹ê»ÚªÑ¥«¡A¥H¶R¤J+½æ¥XªºªÑ¥÷¬°Á`¦¨¥æ¶q¡A¨C¤Ñ­«·s­pºâ¤@¦¸

7.ÃÒ¥æµ|
    ¨C¦¸½æ¥X®É¡A©âµ|¦Ê¤À¤§¤Q¡AÁ×§K¬G·N©Ô°ª¦¨¥æ¶q¤Îµu½u¥æ©ö

8.ªþ¦³¨C¦¸ÅÜ°ÊªºªÑ»ù¬ö¿ý¡B¨«¶Õ¹Ï(¤p®É¬°³æ¦ì)¡B­Ó¤H¥i¬d¸ß¦Û¤vªº«ùªÑ±¡ªp

9.¨C¤Ñ·|²£¥Í¨«¶Õ¹Ï(¦³Á`¦¨¥æ¶q)¡BªÑ»ù¬ö¿ý

-------------------------------------------------------------------------

: include/global.h

#define BMTA_LOGFILE    "run/bmta.log"  /* ¦¬¥~³¡«Hªº°O¿ý */

+ #define FN_RUN_STOCK          "run/stock"         /* ªÑ¥«¸ê®ÆÀÉ */
+ #define FN_RUN_STOCK_RECORD   "run/stock.record"  /* º¦¶^¬ö¿ý */
+ #define FN_RUN_STOCK_INFO     "run/stock.info"    /* ªÑ¥«¨«¶Õ */

: include/struct.h ¥[¤J¥H¤U³o¬q

#ifdef HAVE_GAME

#define MAXSTOCK      8             /* ¤K®a */

typedef struct
{
  int price[MAXSTOCK];          /* »ù®æ */
  int start[MAXSTOCK];          /* ¨C¤éªì©l»ù */
  int change[MAXSTOCK];         /* º¦¶^ */
  int stillnum[MAXSTOCK];       /* ³Ñ¾l¼Æ¶q */
  int ordernum[MAXSTOCK];       /* ¦¨¥æ¶q */
}      STOCK;

#endif

-------------------------------------------------------------------------

: game/stock.c ·s¼W¦¹µ{¦¡

/*-------------------------------------------------------*/
/* stock.c      ( NTHU CS MapleBBS Ver 3.10 )            */
/*-------------------------------------------------------*/
/* target : ªÑ¥«¥æ©ö                                     */
/* create : 04/07/16                                     */
/* update : 04/07/27                                     */
/* author : Efen.bbs@bbs.med.ncku.edu.tw                 */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

#ifdef HAVE_GAME

#define FN_STOCK      "stock"       /* ­Ó¤HªºªÑ¥«ÀÉ®×¡Ð¦UªÑ¾Ö¦³±i¼Æ */

static char stockname[MAXSTOCK][9] =
{
  "¤W »× «Î", "·s ¤Ñ ¦a", "»·ªF¦Ê³f", "²ÎÁp«È¹B",
  "°ê»«¼v«°", "¥Í¬¡¤u§{", "Ä_ ¶® À]", "¦¨¤jÂå¾Ç"
};

static int own[MAXSTOCK];


/*-------------------------------------------------------*/
/* ¿Ã¹õ±±¨î                                              */
/*-------------------------------------------------------*/


static void
show_stock_data(sto)
  STOCK *sto;
{
  int i, change, total, allchange, allordernum, allmoney;

  move(2, 0);
  outs("   \033[1;42m   ½s¸¹  \033[36m°Ó©±¦WºÙ    \033[33m»ù  ®æ"
    "\033[37m(\033[31mº¦    \033[32m¶^\033[37m)  ¥Ø«e¼Æ¶q ¤µ¤é¦¨¥æ¶q"
    "   ¾Ö¦³¼Æ¶q   \033[m\n");
  outs("   \033[46m¡º¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w"
    "¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¡º\033[m\n");

  total = change = ordernum = allmoney = 0;

  for (i = 0; i < MAXSTOCK; i++)
  {
    change = sto->change[i];

    total += sto->price[i];
    allchange += change;
    allordernum += sto->ordernum[i];
    allmoney += own[i] * sto->price[i];

    prints("\033[1m%8d.\033[36m%11s \033[3%dm%8d(%s %8d)"
      "\033[37m%10d%11d%11d\033[m\n",
      i + 1, stockname[i],
      change ? (change > 0 ? 1 : 2) : 7,
      sto->price[i],
      change ? (change > 0 ? "¡µ" : "¡¾") : "¡×",
      abs(change),
      sto->stillnum[i], sto->ordernum[i], own[i]);
  }

  outs("   \033[46m¡º¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w"
    "¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¢w¡º\033[m\n");

  prints("\033[1;37m       ¥[ÅvªÑ»ùÁ`«ü¼Æ¡G\033[3%dm%d  %2s %d"
    "\033[37m      Á`¦¨¥æ¶q¡G%d\033[m\n\n",
    allchange ? (allchange > 0 ? 1 : 2) : 7, total,
    allchange ? (allchange > 0 ? "¡¶" : "¡¿") : "¡×", allchange, allordernum);

  prints("   \033[1;32;45m±zªºªÑ»ùÁ`­È¡G%d »È¹ô\033[m\n\n", allmoney);
  prints("   \033[1;33;45m±zªº¸ê¥»ª÷ÃB¡G%d »È¹ô\033[m", cuser.money);
}


/*-------------------------------------------------------*/
/* ªÑ¥««ü¥O                                              */
/*-------------------------------------------------------*/


static void
stock_query(sto)
  STOCK *sto;
{
  int i;

  clear();
  outs("\033[1;33mÂd¥x¤p©jµ¹±z¤@±i²M³æ¡G\033[\n");
  outs("\033[1;32mªÑ¥«¡G\033[32m«ùªÑ¤@Äýªí\033[m\n\n");
  for (i = 0; i < MAXSTOCK; i++)
  {
    prints("\033[1;3%dm %d.±z¾Ö¦³ %s ªºªÑ¥÷¦@ %8d ±i¡AªÑ»ù [%d]\033[m\n",
      i & 7, i, stockname[i], own[i], sto->price[i]);
  }
  vmsg(NULL);
}


static void
stock_sell(sto)
  STOCK *sto;
{
  int i, num, money;
  char buf[80], ans[8];

  sprintf(buf, "­n½æ­þ®a(1-%d)¡H", MAXSTOCK);
  vget(b_lines, 0, buf, ans, 2, DOECHO);
  i = atoi(ans) - 1;
  if (i < 0 || i >= MAXSTOCK)
    return;

  if (!own[i])
  {
    vmsg("¤wµLªÑ¥÷¥i½æ");
    return;
  }

  sprintf(buf, "­n½æ´X±i(1-%d)¡H", own[i]);
  vget(b_lines, 0, buf, ans, 5, DOECHO);
  num = atoi(ans);
  if (num <= 0 || num > own[i])
    return;

  /* ­«·s¨ú±o¥Ø«eªÑ¥«¨Ã§ó·s */
  rec_get(FN_RUN_STOCK, sto, sizeof(STOCK), 0);
  sto->stillnum[i] += num;
  sto->ordernum[i] += num;
  rec_put(FN_RUN_STOCK, sto, sizeof(STOCK), 0, NULL);

  /* §ó·s«ùªÑ */
  own[i] -= num;
  usr_fpath(buf, cuser.userid, FN_STOCK);
  rec_put(buf, own, sizeof(own), 0, NULL);

  money = sto->price[i] * num * 9 / 10;    /* ¤âÄò¶O */
  addmoney(money);

  sprintf(buf, "½æ¥X %s %d ±i¡A¦¬¤J %d »È¹ô¡I", stockname[i], num, money);
  vmsg(buf);
}


static void
stock_buy(sto)
  STOCK *sto;
{
  int i, num, money;
  char buf[80], ans[8];

  sprintf(buf, "­n¶R­þ®a(1-%d)¡H", MAXSTOCK);
  vget(b_lines, 0, buf, ans, 2, DOECHO);
  i = atoi(ans) - 1;
  if (i < 0 || i >= MAXSTOCK)
    return;

  if (sto->stillnum[i] <= 0)
  {
    vmsg("¤wµLªÑ¥÷¥i¶R");
    return;
  }

  money = cuser.money / sto->price[i];
  sprintf(buf, "­n¶R´X±i(1-%d)¡H", money);
  vget(b_lines, 0, buf, ans, 5, DOECHO);
  num = atoi(ans);
  if (num <= 0 || num > money)
    return;

  /* ­«·s¨ú±o¥Ø«eªÑ¥« */
  rec_get(FN_RUN_STOCK, sto, sizeof(STOCK), 0);

  if (sto->stillnum[i] < num)
  {
    vmsg("ªÑ¥÷­è³Q·m¨«¤F¡A¤U¦¸½Ð¦­¡I");
    return;
  }

  money = sto->price[i] * num;
  if (cuser.money < money)
  {
    vmsg("ªÑ»ù¤wÅÜ°Ê¡A±z¤£°÷ª÷¿úÁÊ¶R");
    return;
  }

  /* §ó·sªÑ¥« */
  sto->stillnum[i] -= num;
  sto->ordernum[i] += num;
  rec_put(FN_RUN_STOCK, sto, sizeof(STOCK), 0, NULL);

  /* §ó·s«ùªÑ */
  own[i] += num;
  usr_fpath(buf, cuser.userid, FN_STOCK);
  rec_put(buf, own, sizeof(own), 0, NULL);

  cuser.money -= money;

  sprintf(buf, "¶R¶i %s %d ±i¡Aªá¶O %d »È¹ô¡I", stockname[i], num, money);
  vmsg(buf);
}


/*-------------------------------------------------------*/
/* ¥Dµ{¦¡                                                */
/*-------------------------------------------------------*/


int
main_stock()
{
  int i;
  char fpath[64];
  STOCK sto;

  if (cutmp->status & STATUS_COINLOCK)
  {
    vmsg(MSG_COINLOCK);
    return XEASY;
  }

  /* §Úªº«ùªÑ */
  usr_fpath(fpath, cuser.userid, FN_STOCK);
  if (rec_get(fpath, own, sizeof(own), 0))
  {
    memset(own, 0, sizeof(own));
    rec_add(fpath, own, sizeof(STOCK));
  }

  /* ¥Ø«eªÑ¥« */
  if (rec_get(FN_RUN_STOCK, &sto, sizeof(STOCK), 0))
  {
    for (i = 0; i < MAXSTOCK; i++)
    {
      sto.price[i] = 100;
      sto.start[i] = 100;
      sto.change[i] = 0;
      sto.stillnum[i] = 100000;
      sto.ordernum[i] = 0;

    }
    rec_add(FN_RUN_STOCK, &sto, sizeof(STOCK));
  }

  while (1)
  {
    clear();
    outs("\033[1;36;44m ¡¹ ¡¹ ¡¹ ¡¹  \033[31m¡i \033[35mÃÒ¨é¥æ©ö©Ò\033[31m ¡j"
      "  \033[36m¡¹ ¡¹ ¡¹ ¡¹         [\033[32mDesign by Efen\033[36m] \033[m");

    show_stock_data(&sto);

    switch (vans("[B:¶R S:½æ C:¬d¸ß F:º¦¶^¬ö¿ý I:¨«¶Õ¹Ï Q:Â÷¶}]"))
    {
    case 'c':
      stock_query(&sto);
      break;

    case 'f':
      more(FN_RUN_STOCK_RECORD, NULL);
      break;

    case 'i':
      more(FN_RUN_STOCK_INFO, NULL);
      break;

    case 's':
      stock_sell(&sto);
      break;

    case 'b':
      stock_buy(&sto);
      break;


    case 'q':
      return 0;
    }
  }
}
#endif    /* HAVE_GAME */

---------------------------------------------------------------------------

: util/stock-change.c ·s¼W¦¹µ{¦¡

/*-------------------------------------------------------*/
/* stock-change.c ( NTHU CS MapleBBS Ver 3.10 )          */
/*-------------------------------------------------------*/
/* target : ªÑ¥«¥æ©öÅÜ¤Æ                                 */
/* create : 04/07/16                                     */
/* update : 04/07/27                                     */
/* author : Efen.bbs@bbs.med.ncku.edu.tw                 */
/* modify : itoc.bbs@bbs.tnfsh.tn.edu.tw                 */
/*-------------------------------------------------------*/


#include "bbs.h"

#ifdef HAVE_GAME

#define MAX_LINE      16

static char *fn_tmpfile = "run/stock.change";
static int ordernum = 0;


static char stockname[MAXSTOCK][9] =
{
  "¤W »× «Î", "·s ¤Ñ ¦a", "»·ªF¦Ê³f", "²ÎÁp«È¹B",
  "°ê»«¼v«°", "¥Í¬¡¤u§{", "Ä_ ¶® À]", "¦¨¤jÂå¾Ç"
};


static void
ansi_puts(fp, buf, mode)
  FILE *fp;
  char *buf, mode;
{
  static char state = '0';

  if (state != mode)
    fprintf(fp, "\033[3%cm", state = mode);
  if (*buf)
  {
    fprintf(fp, buf);
    *buf = '\0';
  }
}


static void
draw_usies(ptime)
  struct tm *ptime;
{
  int num, hour, max, min, item, i, j, over;
  char buf[ANSILINELEN];
  FILE *fp;
  int act[24];

  for (i = 0; i < 24; i++)
    act[i] = 0;

  i = 0;

  if (fp = fopen(fn_tmpfile, "r"))
  {
    while ((fscanf(fp, "%d", &num)) != EOF)
    {
      act[i] = num;
      i++;
    }
    fclose(fp);
  }
  else
    return;

  max = act[0];
  min = act[0];

  for (i = 0; i < 24; i++)
  {
    if (act[i] > max)
      max = act[i];
    else if (act[i] < min && act[i] != 0)
      min = act[i];
  }

  min = (min / 100) * 100;

  for (i = 0; i < 24; i++)
  {
    if (act[i] != 0)
      act[i] -= min;
  }

  max -= min;

  item = max / MAX_LINE + 1;
  over = max > 1000;

  fp = fopen(FN_RUN_STOCK_INFO, "w");

  fprintf(fp, "\t\t\t\033[1;33;46m [%02d/%02d/%02d] ¤µ¤éªÑ¥«¨«¶Õ \033[40m\n",
    ptime->tm_year % 100, ptime->tm_mon + 1, ptime->tm_mday);

  for (i = MAX_LINE + 1; i > 0; i--)
  {
    strcpy(buf, "   ");
    for (j = 0; j < 24; j++)
    {
      max = item * i;
      hour = act[j];
      if (hour && (max > hour) && (max - item <= hour))
      {
        ansi_puts(fp, buf, '3');
        if (over)
          hour = (hour + 5) / 10;
        fprintf(fp, "%-3d", hour);
      }
      else if (max <= hour)
      {
        ansi_puts(fp, buf, '1');
        fprintf(fp, "¢i ");
      }
      else
        strcat(buf, "   ");
    }
    fprintf(fp, "\n");
  }

  fprintf(fp, "\033[34m"
    "  ùæùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùù"
    "ùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùùè\n  \033[32m"
    "0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 "
    "15 16 17 18 19 20 21 22 23\n"
    "\t%s\t\033[m\n"
    "\033[35m°ò­È¡G\033[37m%-10d\033[35mÁ`¦¨¥æ¶q¡G\033[1;37m%d\033[m\n",
    over ? "\033[35m³æ¦ì¡G\033[37m10\033[m" : "", min, ordernum);
  fclose(fp);

  if (ptime->tm_hour == 23)
    unlink(fn_tmpfile);
}


static int
price_change(sto, i, ordernum)    /* ¨M©wªÑ»ùº¦¶^ */
  STOCK *sto;
  int i;
  int ordernum;
{
  int rate;

  /* ¦¹ªÑ¦¨¥æ¶q¦ûÁ`¦¨¥æ¶qªº¤ñ¨Ò¶V°ª¡A¤Wº¦ªº¾÷²v¶V°ª */
  rate = sto->ordernum[i] * 4;
  if (rate > ordernum * 3)          /* ¥»ªÑ¦¨¥æ¶q¦û¤j½L 75%~100% */
    rate = 101;                     /* ´Á±æ¤Wº¦ªÑ»ù 3% */
  else if (rate > ordernum * 2)     /* ¥»ªÑ¦¨¥æ¶q¦û¤j½L 50%~74% */
    rate = 100;                     /* ´Á±æ¤Wº¦ªÑ»ù 2% */
  else if (rate > ordernum * 1)     /* ¥»ªÑ¦¨¥æ¶q¦û¤j½L 25%~49% */
    rate = 99;                      /* ´Á±æ¤Wº¦ªÑ»ù 1% */
  else                              /* ¥»ªÑ¦¨¥æ¶q¦û¤j½L  0%~24% */
    rate = 98;                      /* ´Á±æ¤Wº¦ªÑ»ù 0% */

  rate = sto->price[i] * (rnd(5) + rate) / 100;
  if (rate <= 0)
    rate = 1;

  sto->change[i] = rate - sto->price[i];
  sto->price[i] = rate;
}


int
main()
{
  int i, totalprice;
  STOCK sto;
  time_t now;
  struct tm *ptime;
  FILE *fp;

  now = time(NULL);
  ptime = localtime(&now);

  chdir(BBSHOME);

  /* ¨ú±o¥Ø«eªÑ¥« */
  rec_get(FN_RUN_STOCK, &sto, sizeof(STOCK), 0);

  /* ºâÁ`¦¨¥æ¶q */
  for (i = 0; i < MAXSTOCK; i++)
    ordernum += sto.ordernum[i];

  /* §ó·sªÑ¥« */
  totalprice = 0;
  srand(now);
  for (i = 0; i < MAXSTOCK; i++)
  {
    price_change(&sto, i, ordernum);
    sto.stillnum[i] += rnd(6);

    if (ptime->tm_hour == 0 && ptime->tm_min == 5)
    {
      sto.start[i] = sto.price[i];
      sto.ordernum[i] = 0;
    }

    totalprice += sto.price[i];
  }
  rec_put(FN_RUN_STOCK, &sto, sizeof(STOCK), 0, NULL);

  /* ¼g¤Jº¦¶^¬ö¿ý */
  if (fp = fopen(FN_RUN_STOCK_RECORD, "a"))
  {
    fprintf(fp, "\033[1;33m%s\033[m\n", Btime(&now));

    for (i = 0; i < MAXSTOCK; i++)
      fprintf(fp, "%9s", stockname[i]);
    fprintf(fp, "\n");

    for (i = 0; i < MAXSTOCK; i++)
      fprintf(fp, "%8d ", sto.price[i]);
    fprintf(fp, "\n\n");

    fclose(fp);
  }

  /* µe¨«¶Õ¹Ï */
  if (ptime->tm_min == 5)
  {
    fp = fopen(fn_tmpfile, "a+");
    fprintf(fp, "%d\n", totalprice / 1000);
    fclose(fp);
    draw_usies(ptime);
  }

  return 0;
}
#else
int
main()
{
  printf("You should define HAVE_GAME first.\n");
  return -1;
}
#endif    /* HAVE_GAME */


---------------------------------------------------------------------------

: util/account.c

    sprintf(title, "%s»Ä²¢­W»¶¯d¨¥ªO", date);
    keeplog(FN_RUN_NOTE_ALL, NULL, title, 2);

+#ifdef HAVE_GAME
+   sprintf(title, "%sªÑ¥«º¦¶^¬ö¿ý", date);
+   keeplog(FN_RUN_STOCK_RECORD, NULL, title, 2);

+   sprintf(title, "%sªÑ¥«¨«¶Õ", date);
+   keeplog(FN_RUN_STOCK_INFO, NULL, title, 0);
+#endif

-------------------------------------------------------------------------

: crontab -e ¦b³Ì«á¥[¤J

# ªÑ¥«ÅÜ´«
5,25,45 * * * * bin/stock-change > /dev/null 2>&1



.....®t¤£¦h­n©ñ¤U¥D¾÷ºÞ²zªº¤u§@¤F....´N§â³o°}¤l§V¤Oªº¦¨ªG¸ò¤j®a¤À¨ÉÅo....
³oºâ¬O¥»¯¸³Ì¤jªº¤@­Ó­×­×§ï§ï·Q·Q¥b¦Û³Ðªºµ{¦¡¤F§a
--
[0m[1;31;44m ¡y¢~¢£[33m¦¨¤jÂå¾Ç[31m¢~¢£ [32m¢ª[35m¢¨      [37m¡Ë  ¡¸ [35m¢[32mi[33m¢[36mi [32mbbs.med.ncku.edu.tw [36m¢[33mi[32m¢[35mi [37m¡¸  ¡Ê     [0m
[0m[1;31;42m ¢~¢£[33m°j ­· ¨¦[31m¢~¢£¡z [31m¢«[34m¢© [37m¡÷From¡G[36m140.116.144.137                            [37m¡ö[0m
